/**
 * skylark-texts-plain - The skylarkjs plain utility Library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-arrays","./position","./selection"],function(e,t,n){"use strict";function l(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function o(e,n){let l={from:t.copy(n.from),to:change_measurement.changeEnd(n),text:e.getBetween(n.from,n.to)};return r(e,l,n.from.line,n.to.line+1),document_data.linkedDocs(e,e=>r(e,l,n.from.line,n.to.line+1),!0),l}function i(t){for(;t.length;){if(!e.last(t).ranges)break;t.pop()}}function s(t,n){let l=e.last(n);l&&l.ranges&&l.equals(t)||n.push(t)}function r(e,t,n,l){let o=t["spans_"+e.id],i=0;e.iter(Math.max(e.first,n),Math.min(e.first+e.size,l),n=>{n.markedSpans&&((o||(o=t["spans_"+e.id]={}))[i]=n.markedSpans),++i})}function a(e){if(!e)return null;let t;for(let n=0;n<e.length;++n)e[n].marker.explicitlyCleared?t||(t=e.slice(0,n)):t&&t.push(e[n]);return t?t.length?t:null:e}return l.historyChangeFromChange=o,l.addChangeToHistory=function(n,l,r,a){let h=n.history;h.undone.length=0;let g,d,u=+new Date;if((h.lastOp==a||h.lastOrigin==l.origin&&l.origin&&("+"==l.origin.charAt(0)&&h.lastModTime>u-(n.cm?n.cm.options.historyEventDelay:500)||"*"==l.origin.charAt(0)))&&(g=function(t,n){return n?(i(t.done),e.last(t.done)):t.done.length&&!e.last(t.done).ranges?e.last(t.done):t.done.length>1&&!t.done[t.done.length-2].ranges?(t.done.pop(),e.last(t.done)):void 0}(h,h.lastOp==a)))d=e.last(g.changes),0==t.compare(l.from,l.to)&&0==t.compare(l.from,d.to)?d.to=change_measurement.changeEnd(l):g.changes.push(o(n,l));else{let t=e.last(h.done);for(t&&t.ranges||s(n.sel,h.done),g={changes:[o(n,l)],generation:h.generation},h.done.push(g);h.done.length>h.undoDepth;)h.done.shift(),h.done[0].ranges||h.done.shift()}h.done.push(r),h.generation=++h.maxGeneration,h.lastModTime=h.lastSelTime=u,h.lastOp=h.lastSelOp=a,h.lastOrigin=h.lastSelOrigin=l.origin,d||n.emit("historyAdded")},l.addSelectionToHistory=function(t,n,l,o){let r=t.history,a=o&&o.origin;l==r.lastSelOp||a&&r.lastSelOrigin==a&&(r.lastModTime==r.lastSelTime&&r.lastOrigin==a||function(e,t,n,l){let o=t.charAt(0);return"*"==o||"+"==o&&n.ranges.length==l.ranges.length&&n.somethingSelected()==l.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}(t,a,e.last(r.done),n))?r.done[r.done.length-1]=n:s(n,r.done),r.lastSelTime=+new Date,r.lastSelOrigin=a,r.lastSelOp=l,o&&!1!==o.clearRedo&&i(r.undone)},l.pushSelectionToHistory=s,l.mergeOldSpans=function(e,t){let n=function(e,t){let n=t["spans_"+e.id];if(!n)return null;let l=[];for(let e=0;e<t.text.length;++e)l.push(a(n[e]));return l}(e,t),l=spans.stretchSpansOverChange(e,t);if(!n)return l;if(!l)return n;for(let e=0;e<n.length;++e){let t=n[e],o=l[e];if(t&&o)e:for(let e=0;e<o.length;++e){let n=o[e];for(let e=0;e<t.length;++e)if(t[e].marker==n.marker)continue e;t.push(n)}else o&&(n[e]=o)}return n},l.copyHistoryArray=function(t,l,o){let i=[];for(let r=0;r<t.length;++r){let a=t[r];if(a.ranges){i.push(o?n.prototype.deepCopy.call(a):a);continue}let h=a.changes,g=[];i.push({changes:g});for(let t=0;t<h.length;++t){let n,o=h[t];if(g.push({from:o.from,to:o.to,text:o.text}),l)for(var s in o)(n=s.match(/^spans_(\d+)$/))&&e.indexOf(l,Number(n[1]))>-1&&(e.last(g)[s]=o[s],delete o[s])}}return i},l});
//# sourceMappingURL=sourcemaps/history.js.map
