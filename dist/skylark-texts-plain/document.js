/**
 * skylark-texts-plain - The skylarkjs plain utility Library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx/arrays","skylark-langx/Evented","./plain","./branch_chunk","./leaf_chunk","./position","./selection","./history"],function(t,e,i,n,s,r,l,o){"use strict";let h=0;var c=n.inherit({_construct:function(t,e,i,n,o){null==i&&(i=0),thie.overrited(new s([new Line("",null)])),this.first=i,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=i;let c=new r(i,0);this.sel=l.simple(c),this.history=new m_history.History(null),this.id=++h,this.modeOption=e,this.lineSep=n,this.direction="rtl"==o?"rtl":"ltr",this.extend=!1,"string"==typeof t&&(t=this.splitLines(t)),document_data.updateDoc(this,{from:c,to:c,text:t}),selection_updates.setSelection(this,l.simple(c),misc.sel_dontScroll)},iter:function(t,e,i){i?this.iterN(t-this.first,e-t,i):this.iterN(this.first,this.first+this.size,t)},insert:function(t,e){let i=0;for(let t=0;t<e.length;++t)i+=e[t].height;this.insertInner(t-this.first,e,i)},remove:function(t,e){this.removeInner(t-this.first,e)},getValue:function(t){let e=this.getLines(this.first,this.first+this.size);return!1===t?e:e.join(t||this.lineSeparator())},setValue:function(t){let e=new r(this.first,0),i=this.first+this.size-1;changes.makeChange(this,{from:e,to:new r(i,this.getLineHandle(i).text.length),text:this.splitLines(t),origin:"setValue",full:!0},!0),this.cm&&scrolling.scrollToCoords(this.cm,0,0),selection_updates.setSelection(this,l.simple(e),misc.sel_dontScroll)},replaceRange:function(t,e,i,n){e=this.clipPos(e),i=i?this.clipPos(i):e,changes.replaceRange(this,t,e,i,n)},getRange:function(t,e,i){let n=this.getBetween(this.clipPos(t),this.clipPos(e));return!1===i?n:n.join(i||this.lineSeparator())},getBetween:function(t,e){let i=[],n=t.line;return this.iter(t.line,e.line+1,s=>{let r=s.text;n==e.line&&(r=r.slice(0,e.ch)),n==t.line&&(r=r.slice(t.ch)),i.push(r),++n}),i},getLine:function(t){let e=this.getLineHandle(t);return e&&e.text},getLines:function(t,e){let i=[];return this.iter(t,e,t=>{i.push(t.text)}),i},getLineHandle:function(t){if((t-=this.first)<0||t>=this.size)throw new Error("There is no line "+(t+this.first)+" in the document.");let e=this;for(;!e.lines;)for(let i=0;;++i){let n=e.children[i],s=n.chunkSize();if(t<s){e=n;break}t-=s}return e.lines[t]},getLineNumber:function(e){if(null==e.parent)return null;let i=e.parent,n=t.indexOf(i.lines,e);for(let t=i.parent;t;i=t,t=t.parent)for(let e=0;t.children[e]!=i;++e)n+=t.children[e].chunkSize();return n+i.first},getLineHandleVisualStart:function(t){return"number"==typeof t&&(t=this.getLineHandle(t)),spans.visualLine(t)},isLine:function(t){return t>=this.first&&t<this.first+this.size},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(t){if(t.line<this.first)return new r(this.first,0);let e=this.first+this.size-1;return t.line>e?r(e,this.getLineHandle(e).text.length):t.clipToLen(this.getLineHandle(t.line).text.length)},getCursor:function(t){let e,i=this.sel.primary();return e=null==t||"head"==t?i.head:"anchor"==t?i.anchor:"end"==t||"to"==t||!1===t?i.to():i.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:function(t,e,i){selection_updates.setSimpleSelection(this,this.clipPos("number"==typeof t?new r(t,e||0):t),null,i)},setSelection:function(t,e,i){selection_updates.setSimpleSelection(this,this.clipPos(t),this.clipPos(e||t),i)},extendSelection:function(t,e,i){selection_updates.extendSelection(this,this.clipPos(t),e&&this.clipPos(e),i)},extendSelections:function(t,e){selection_updates.extendSelections(this,m_pos.clipPosArray(this,t),e)},extendSelectionsBy:function(t,e){let i=misc.map(this.sel.ranges,t);selection_updates.extendSelections(this,m_pos.clipPosArray(this,i),e)},setSelections:function(t,e,i){if(!t.length)return;let n=[];for(let e=0;e<t.length;e++)n[e]=new m_selection.Range(this.clipPos(t[e].anchor),this.clipPos(t[e].head));null==e&&(e=Math.min(t.length-1,this.sel.primIndex)),selection_updates.setSelection(this,l.normalize(this.cm,n,e),i)},addSelection:function(t,e,i){let n=this.sel.ranges.slice(0);n.push(new m_selection.Range(this.clipPos(t),this.clipPos(e||t))),selection_updates.setSelection(this,m_selection.normalizeSelection(this.cm,n,n.length-1),i)},getSelection:function(t){let e,i=this.sel.ranges;for(let t=0;t<i.length;t++){let n=this.getBetween(i[t].from(),i[t].to());e=e?e.concat(n):n}return!1===t?e:e.join(t||this.lineSeparator())},getSelections:function(t){let e=[],i=this.sel.ranges;for(let n=0;n<i.length;n++){let s=this.getBetween(i[n].from(),i[n].to());!1!==t&&(s=s.join(t||this.lineSeparator())),e[n]=s}return e},replaceSelection:function(t,e,i){let n=[];for(let e=0;e<this.sel.ranges.length;e++)n[e]=t;this.replaceSelections(n,e,i||"+input")},replaceSelections:function(t,e,i){let n=[],s=this.sel;for(let e=0;e<s.ranges.length;e++){let r=s.ranges[e];n[e]={from:r.from(),to:r.to(),text:this.splitLines(t[e]),origin:i}}let r=e&&"end"!=e&&change_measurement.computeReplacedSel(this,n,e);for(let t=n.length-1;t>=0;t--)n.makeChange(this,n[t]);r?selection_updates.setSelectionReplaceHistory(this,r):this.cm&&scrolling.ensureCursorVisible(this.cm)},undo:function(){changes.makeChangeFromHistory(this,"undo")},redo:function(){changes.makeChangeFromHistory(this,"redo")},undoSelection:function(){changes.makeChangeFromHistory(this,"undo",!0)},redoSelection:function(){changes.makeChangeFromHistory(this,"redo",!0)},setExtending:function(t){this.extend=t},getExtending:function(){return this.extend},historySize:function(){let t=this.history,e=0,i=0;for(let i=0;i<t.done.length;i++)t.done[i].ranges||++e;for(let e=0;e<t.undone.length;e++)t.undone[e].ranges||++i;return{undo:e,redo:i}},clearHistory:function(){this.history=new m_history.History(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(t){return t&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(t){return this.history.generation==(t||this.cleanGeneration)},getHistory:function(){return{done:m_history.copyHistoryArray(this.history.done),undone:m_history.copyHistoryArray(this.history.undone)}},setHistory:function(t){let e=this.history=new m_history.History(this.history.maxGeneration);e.done=m_history.copyHistoryArray(t.done.slice(0),null,!0),e.undone=m_history.copyHistoryArray(t.undone.slice(0),null,!0)},setGutterMarker:function(t,e,i){return changes.changeLine(this,t,"gutter",t=>{let n=t.gutterMarkers||(t.gutterMarkers={});return n[e]=i,!i&&misc.isEmpty(n)&&(t.gutterMarkers=null),!0})},clearGutter:function(t){this.iter(e=>{e.gutterMarkers&&e.gutterMarkers[t]&&changes.changeLine(this,e,"gutter",()=>(e.gutterMarkers[t]=null,misc.isEmpty(e.gutterMarkers)&&(e.gutterMarkers=null),!0))})},lineInfo:function(t){let e;if("number"==typeof t){if(!this.isLine(t))return null;if(e=t,!(t=this.getLineHandle(t)))return null}else if(null==(e=this.getLineNumber(t)))return null;return{line:e,handle:t,text:t.text,gutterMarkers:t.gutterMarkers,textClass:t.textClass,bgClass:t.bgClass,wrapClass:t.wrapClass,widgets:t.widgets}},addLineClass:function(t,e,i){return changes.changeLine(this,t,"gutter"==e?"gutter":"class",t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass";if(t[n]){if(dom.classTest(i).test(t[n]))return!1;t[n]+=" "+i}else t[n]=i;return!0})},removeLineClass:function(t,e,i){return changes.changeLine(this,t,"gutter"==e?"gutter":"class",t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass",s=t[n];if(!s)return!1;if(null==i)t[n]=null;else{let e=s.match(dom.classTest(i));if(!e)return!1;let r=e.index+e[0].length;t[n]=s.slice(0,e.index)+(e.index&&r!=s.length?" ":"")+s.slice(r)||null}return!0})},addLineWidget:function(t,e,i){return line_widget.addLineWidget(this,t,e,i)},removeLineWidget:function(t){t.clear()},markText:function(t,e,i){return mark_text.markText(this,this.clipPos(t),this.clipPos(e),i,i&&i.type||"range")},setBookmark:function(t,e){let i={replacedWith:e&&(null==e.nodeType?e.widget:e),insertLeft:e&&e.insertLeft,clearWhenEmpty:!1,shared:e&&e.shared,handleMouseEvents:e&&e.handleMouseEvents};return t=this.clipPos(t),p.markText(this,t,t,i,"bookmark")},findMarksAt:function(t){t=this.clipPos(t);let e=[],i=this.getLineHandle(t.line).markedSpans;if(i)for(let n=0;n<i.length;++n){let s=i[n];(null==s.from||s.from<=t.ch)&&(null==s.to||s.to>=t.ch)&&e.push(s.marker.parent||s.marker)}return e},findMarks:function(t,e,i){t=this.clipPos(t),e=this.clipPos(e);let n=[],s=t.line;return this.iter(t.line,e.line+1,r=>{let l=r.markedSpans;if(l)for(let r=0;r<l.length;r++){let o=l[r];null!=o.to&&s==t.line&&t.ch>=o.to||null==o.from&&s!=t.line||null!=o.from&&s==e.line&&o.from>=e.ch||i&&!i(o.marker)||n.push(o.marker.parent||o.marker)}++s}),n},getAllMarks:function(){let t=[];return this.iter(e=>{let i=e.markedSpans;if(i)for(let e=0;e<i.length;++e)null!=i[e].from&&t.push(i[e].marker)}),t},posFromIndex:function(t){let e,i=this.first,n=this.lineSeparator().length;return this.iter(s=>{let r=s.text.length+n;if(r>t)return e=t,!0;t-=r,++i}),this.clipPos(new r(i,e))},indexFromPos:function(t){let e=(t=this.clipPos(t)).ch;if(t.line<this.first||t.ch<0)return 0;let i=this.lineSeparator().length;return this.iter(this.first,t.line,t=>{e+=t.text.length+i}),e},copy:function(t){let e=new c(this.getLines(this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return e.scrollTop=this.scrollTop,e.scrollLeft=this.scrollLeft,e.sel=this.sel,e.extend=!1,t&&(e.history.undoDepth=this.history.undoDepth,e.setHistory(this.getHistory())),e},linkedDoc:function(t){t||(t={});let e=this.first,i=this.first+this.size;null!=t.from&&t.from>e&&(e=t.from),null!=t.to&&t.to<i&&(i=t.to);let n=new c(this.getLines(e,i),t.mode||this.modeOption,e,this.lineSep,this.direction);return t.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:t.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:t.sharedHist}],line_widget.copySharedMarkers(n,line_widget.findSharedMarkers(this)),n},unlinkDoc:function(t){if(t.doc&&(t=t.doc),this.linked)for(let e=0;e<this.linked.length;++e){if(this.linked[e].doc==t){this.linked.splice(e,1),t.unlinkDoc(this),line_widget.detachSharedMarkers(line_widget.findSharedMarkers(this));break}}if(t.history==this.history){let e=[t.id];document_data.linkedDocs(t,t=>e.push(t.id),!0),t.history=new m_history.History(null),t.history.done=m_history.copyHistoryArray(this.history.done,e),t.history.undone=m_history.copyHistoryArray(this.history.undone,e)}},iterLinkedDocs:function(t){document_data.linkedDocs(this,t)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(t){return this.lineSep?t.split(this.lineSep):feature_detection.splitLinesAuto(t)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:function(t){"rtl"!=t&&(t="ltr"),t!=this.direction&&(this.direction=t,this.iter(t=>t.order=null),this.emit("directionChanged"))}});return c.prototype.eachLine=c.prototype.iter,i.Document=c});
//# sourceMappingURL=sourcemaps/document.js.map
